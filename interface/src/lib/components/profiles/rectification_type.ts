/**
 * Физические характеристики конкретного электромагнитного клапана.
 * Используется для ограничения расчетов под возможности "железа".
 */
export interface ValveHardware {
	/** Максимальная пропускная способность клапана при 100% открытии (мл/час) */
	hardwareMaxMlph: number;
	/** Минимальный импульс открытия в секундах, который клапан может отработать стабильно (например, 0.1) */
	minOpenTimeSec: number;
}

/**
 * Конфигурация конкретного этапа отбора (цели и временные интервалы).
 */
export interface StageConfig {
	/** Целевая скорость отбора для данного этапа (мл/час) */
	targetFlowMlph: number;
	/** Желаемый период ШИМ в секундах (например, 5 или 10) */
	preferredPeriodSec: number;

	/** * Ручное переопределение периода.
	 * Если заполнено, алгоритм динамического расширения игнорируется.
	 */
	manualPeriod?: number | null;

	/** * Ручное переопределение времени открытия.
	 * Если заполнено, расчет на основе скорости игнорируется.
	 */
	manualOpen?: number | null;
}

/**
 * Результат расчета управления, который передается непосредственно на контроллер.
 */
export interface ValveControl {
	/** Время, на которое нужно открыть клапан в каждом цикле (секунды, float) */
	open: number;
	/** Общая длительность одного цикла (секунды, int) */
	period: number;
	/** Признак того, что значения были введены вручную, а не рассчитаны автоматически */
	isManual: boolean;
}

/**
 * Глобальная конфигурация процесса ректификации.
 * Определяет цели (объемы, крепость) и параметры оборудования.
 */
export interface RectificationConfig {
	// --- Параметры сырца ---
	/** Объем спирта-сырца в кубе (литры, точность 0.1) */
	rawVolumeLiters: number;
	/** Спиртуозность сырца по показаниям ареометра (%) */
	rawStrength: number;
	/** Температура сырца при замере спиртуозности (°C) */
	rawTemperature: number;
	/** Желаемая крепость продукта на выходе (например, 96.6) */
	targetStrength: number;

	// --- Целевые объемы фракций (в % от абсолютного спирта) ---
	/** Суммарный объем головных фракций (%) */
	headsTotalPercent: number;
	/** Объем подголовников (оборотного спирта) (%) */
	lateHeadsPercent: number;
	/** Объем хвостовых фракций (%). Тело рассчитывается как остаток. */
	tailsPercent: number;

	/**
	 * Режим работы:
	 * true - детальный (сброс голов, ramp, подголовники; хвосты остаются в кубе).
	 * false - стандартный (головы, тело, хвосты отбираются последовательно).
	 */
	detailedMode: boolean;

	// --- Конфигурация скоростей и клапанов для каждого этапа ---
	stages: {
		/** Этап "тяжелых" голов (используется для сброса и начала ramp-а) */
		headsHeavy: StageConfig;
		/** Этап "легких" голов (используется для конца ramp-а) */
		headsLight: StageConfig;
		/** Этап подголовников */
		lateHeads: StageConfig;
		/** Основной этап отбора товарного спирта */
		body: StageConfig;
		/** Этап отбора хвостов */
		tails: StageConfig;
	};

	hardware: {
		headsValve: ValveHardware;
		lateHeadsValve: ValveHardware;
		heartsValve: ValveHardware;
		tailsValve: ValveHardware;
	};
}

/**
 * Отчет по одной строке (фракции) в итоговой таблице расчета.
 */
export interface ReportRow {
	/** Название фракции (например, "Головы", "Тело") */
	name: string;
	/** Рассчитанный объем фракции в миллилитрах */
	ml: number;
	/** Рассчитанная длительность этапа в минутах */
	durationMin: number;
	/** Параметры ШИМ для основного клапана (или начальные для ramp-режима) */
	controlA: ValveControl;
	/** Параметры ШИМ для второго клапана (или конечные для ramp-режима) */
	controlB: ValveControl | null;
}

/**
 * Итоговый отчет, который является результатом всех вычислений.
 */
export interface RectificationReport {
	/** Реальная крепость сырца с учетом температурной коррекции */
	realRawStrength: number;
	/** Общий объем абсолютного спирта в сырце (мл) */
	absoluteAlcoholMl: number;
	/** Массив строк с результатами по каждой фракции */
	rows: ReportRow[];
	/** Расчетный остаток в кубе после отбора (литры) */
	stillageLiters: number;
	/** Общее время всего процесса ректификации (минуты) */
	totalTimeMin: number;
}
